# GitLab CI configuration to run Liquibase migrations
# - The job uses the official Liquibase image and downloads the MySQL JDBC driver at runtime.
# - Set the MySQL connection variables in GitLab CI/CD (recommended to mask the password).

stages:
  - migrate

variables:
  JDBC_VERSION: "8.0.30"
  MYSQL_HOST: "host.docker.internal"
  MYSQL_PORT: "3306"
  MYSQL_DB: "reservation_db"
  MYSQL_USER: "root"
  MYSQL_PASSWORD: ""

liquibase-migrate:
  image: liquibase/liquibase:4.30.0
  stage: migrate
  # Run on commits to main/master by default, and run manually to avoid accidental schema changes
  only:
    - main
    - master
  when: manual
  timeout: 20m
  script:
    - mkdir -p database/liquibase/drivers
    - |
      wget -q -O database/liquibase/drivers/mysql-connector-java-${JDBC_VERSION}.jar \
        https://repo1.maven.org/maven2/mysql/mysql-connector-java/${JDBC_VERSION}/mysql-connector-java-${JDBC_VERSION}.jar
    - liquibase \
        --url="jdbc:mysql://${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DB}" \
        --username="${MYSQL_USER}" \
        --password="${MYSQL_PASSWORD}" \
        --changeLogFile="database/liquibase/changelog.xml" \
        --classpath="database/liquibase/drivers/mysql-connector-java-${JDBC_VERSION}.jar" \
        update --searchPath=database/liquibase
